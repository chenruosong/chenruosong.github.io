<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Pdo长连接导致Mysql has gone away排查记录 | 凉凉的超人</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="一、背景描述线上环境nginx errorlog频繁输出以下日志    2021&#x2F;04&#x2F;26 09:32:07 [error] 12202#12202: *4270291 FastCGI sent in stderr: &quot;PHP message: PHP Warning:  PDO::__construct(): MySQL server has gone away in &#x2F;xxx&#x2F;Pd">
<meta property="og:type" content="article">
<meta property="og:title" content="Pdo长连接导致Mysql has gone away排查记录">
<meta property="og:url" content="http://chenruosong.com/2021/04/26/%E4%B8%80%E6%AC%A1%E7%BA%BF%E4%B8%8AMysql-has-gone-away%E6%8E%92%E6%9F%A5%E8%AE%B0%E5%BD%95/">
<meta property="og:site_name" content="凉凉的超人">
<meta property="og:description" content="一、背景描述线上环境nginx errorlog频繁输出以下日志    2021&#x2F;04&#x2F;26 09:32:07 [error] 12202#12202: *4270291 FastCGI sent in stderr: &quot;PHP message: PHP Warning:  PDO::__construct(): MySQL server has gone away in &#x2F;xxx&#x2F;Pd">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://github.com/chenruosong/blog/blob/master/source/image/PdoMysqlPersistent/291F3661-B03E-40AA-AEC6-0B11CB1F6F98.png">
<meta property="og:image" content="https://github.com/chenruosong/blog/blob/master/source/image/PdoMysqlPersistent/893089C7-4599-4D6A-9F88-1FACF3251913.png">
<meta property="og:image" content="https://github.com/chenruosong/blog/blob/master/source/image/PdoMysqlPersistent/3aiMD2QxfyWA1Ze.png">
<meta property="article:published_time" content="2021-04-26T01:31:16.000Z">
<meta property="article:modified_time" content="2021-04-28T09:14:51.227Z">
<meta property="article:author" content="Chen">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://github.com/chenruosong/blog/blob/master/source/image/PdoMysqlPersistent/291F3661-B03E-40AA-AEC6-0B11CB1F6F98.png">
  
    <link rel="alternate" href="/atom.xml" title="凉凉的超人" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 5.4.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">凉凉的超人</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS 订阅"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="搜索"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="搜索"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://chenruosong.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-一次线上Mysql-has-gone-away排查记录" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/04/26/%E4%B8%80%E6%AC%A1%E7%BA%BF%E4%B8%8AMysql-has-gone-away%E6%8E%92%E6%9F%A5%E8%AE%B0%E5%BD%95/" class="article-date">
  <time class="dt-published" datetime="2021-04-26T01:31:16.000Z" itemprop="datePublished">2021-04-26</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      Pdo长连接导致Mysql has gone away排查记录
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="一、背景描述"><a href="#一、背景描述" class="headerlink" title="一、背景描述"></a>一、背景描述</h2><p>线上环境nginx errorlog频繁输出以下日志  </p>
<ul>
<li><code>2021/04/26 09:32:07 [error] 12202#12202: *4270291 FastCGI sent in stderr: &quot;PHP message: PHP Warning:  PDO::__construct(): MySQL server has gone away in /xxx/PdoConn.php on line 57&quot; while reading response header from upstream, client: xxx, server: xxx.com, request ......</code></li>
</ul>
<p>几个疑惑点</p>
<ul>
<li>warning是在new Pdo对象时抛出的(app/connector/mysql/PdoConn.php:57)<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">$this</span>-&gt;pdo = <span class="keyword">new</span> PDO(<span class="variable">$dsn</span>, <span class="keyword">$this</span>-&gt;config[<span class="string">&quot;username&quot;</span>], <span class="keyword">$this</span>-&gt;config[<span class="string">&quot;password&quot;</span>], <span class="keyword">array</span>(PDO::ATTR_PERSISTENT =&gt; <span class="literal">true</span>));</span><br></pre></td></tr></table></figure></li>
<li>(主库68.95:3306,伏笔) netstat查看php worker机(90/91)到mysqld的连接端口,相隔一段时间内并没有变化，且Threads_created没有增长，说明没有建立新的连接</li>
</ul>
<p>首先经过简单的日志分析配合抓包发现：</p>
<ul>
<li>该warning基本覆盖大部分请求,非特定接口导致</li>
<li>复现概率较高，但不是必现</li>
<li>不影响正常业务逻辑，接口能正常响应，返回数据（ping+重连？）</li>
</ul>
<h2 id="二、问题分析"><a href="#二、问题分析" class="headerlink" title="二、问题分析"></a>二、问题分析</h2><h3 id="Mysql-has-gone-away"><a href="#Mysql-has-gone-away" class="headerlink" title="Mysql has gone away"></a><strong>Mysql has gone away</strong></h3><p>首先根据 <a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/8.0/en/gone-away.html">mysql官方文档</a> 找出可能导致抛出<code>MySQL server has gone away</code>的原因有：  </p>
<p>The most common reason for the MySQL server has gone away error is that <strong>the server timed out and closed the connection</strong>. In this case, you normally get one of the following error codes (which one you get is operating system-dependent).</p>
<p>Some other common reasons for the MySQL server has gone away error are:</p>
<ol>
<li><p>You (or the db administrator) has <strong>killed</strong> the running thread with a KILL statement or a mysqladmin kill command. (x)</p>
</li>
<li><p>You tried to run a <strong>query</strong> after closing the connection to the server. This indicates a logic error in the application that should be corrected. (x)</p>
</li>
<li><p>A client application running on a different host does not have the necessary <strong>privileges</strong> to connect to the MySQL server from that host. (x)</p>
</li>
<li><p>You got a <strong>timeout from the TCP/IP connection</strong> on the client side. This may happen if you have been using the commands: mysql_options(…, MYSQL_OPT_READ_TIMEOUT,…) or mysql_options(…, MYSQL_OPT_WRITE_TIMEOUT,…). In this case increasing the timeout may help solve the problem.(x)</p>
</li>
<li><p>You have encountered a timeout on the server side and the automatic reconnection in the client is disabled (the reconnect flag in the MYSQL structure is equal to 0). (?)</p>
</li>
<li><p>You are using a Windows client and the server had dropped the connection (probably because <strong>wait_timeout</strong> expired) before the command was issued.</p>
</li>
<li><p>The problem on Windows is that in some cases MySQL does not get an error from the OS when writing to the TCP/IP connection to the server, but instead gets the error when trying to read the answer from the connection.</p>
</li>
<li><p>The solution to this is to either do a mysql_ping() on the connection if there has been a long time since the last query (this is what Connector/ODBC does) or set <strong>wait_timeout</strong> on the mysqld server so high that it in practice never times out.</p>
</li>
<li><p>You can also get these errors if you send a query to the server that is <strong>incorrect or too large</strong>. If mysqld receives a packet that is too large or out of order, it assumes that something has gone wrong with the client and closes the connection. If you need big queries (for example, if you are working with big BLOB columns), you can increase the query limit by setting the server’s max_allowed_packet variable, which has a default value of 64MB. You may also need to increase the maximum packet size on the client end. More information on setting the packet size is given in Section B.3.2.8, “Packet Too Large”.</p>
</li>
<li><p>An INSERT or REPLACE statement that inserts <strong>a great many rows</strong> can also cause these sorts of errors. Either one of these statements sends a single request to the server irrespective of the number of rows to be inserted; thus, you can often avoid the error by reducing the number of rows sent per INSERT or REPLACE.</p>
</li>
<li><p>It is also possible to see this error if <strong>host name lookups fail</strong> (for example, if the DNS server on which your server or network relies goes down). This is because MySQL is dependent on the host system for name resolution, but has no way of knowing whether it is working—from MySQL’s point of view the problem is indistinguishable from any other network timeout.<br>You may also see the MySQL server has gone away error if MySQL is started with the skip_networking system variable enabled.</p>
</li>
<li><p>Another networking issue that can cause this error occurs if the MySQL port (default 3306) is blocked by your <strong>firewall</strong>, thus preventing any connections at all to the MySQL server.</p>
</li>
<li><p>You can also encounter this error with applications that <strong>fork child processes</strong>, all of which try to use the same connection to the MySQL server. This can be avoided by using a separate connection for each child process.(x)</p>
</li>
<li><p>You have encountered a <strong>bug</strong> where the server died while executing the query.</p>
</li>
</ol>
<p>虽然官方列出的原因有很多，涵盖的范围也比较广：包括客户端、服务端、driver、网络连接、甚至DBA的人为操作原因，根据我们的问题背景在过滤调其中一部分之后，可以看出主要还是围绕 <strong>超时断开链接</strong> 这一核心原因展开的分析，下面我们再针对这些详细情况逐一进行排查。</p>
<h3 id="pdo-长链接"><a href="#pdo-长链接" class="headerlink" title="pdo 长链接"></a><strong>pdo 长链接</strong></h3><p><em>长连接依托于常驻进程，命令行模式下，脚本执行完毕后连接必然会被释放，在php-fpm执行模式下，fastcgi执行完一次请求后，后面的请求可以继续复用前一次请求创建的连接，从而省去了建立连接的开销，提升了性能。</em></p>
<h2 id="三、排查过程"><a href="#三、排查过程" class="headerlink" title="三、排查过程"></a>三、排查过程</h2><h3 id="1-wait-timeout"><a href="#1-wait-timeout" class="headerlink" title="1.wait_timeout"></a>1.wait_timeout</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">The number of seconds the server waits for activity on a noninteractive connection before closing it.</span><br></pre></td></tr></table></figure>

<p>wait_timeout是一个全局变量，指的是在客户端与服务器建立链接后超过该变量指定的时间（单位秒）未发送任何指令，链接将会自动断开。通过下面命令可以查看当前mysql服务中的各种超时时间配置。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">MariaDB []<span class="operator">&gt;</span> <span class="keyword">show</span> <span class="keyword">global</span> variables <span class="keyword">like</span> <span class="string">&#x27;%timeout&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------------------+----------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name               <span class="operator">|</span> <span class="keyword">Value</span>    <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------------------+----------+</span></span><br><span class="line"><span class="operator">|</span> connect_timeout             <span class="operator">|</span> <span class="number">10</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> delayed_insert_timeout      <span class="operator">|</span> <span class="number">300</span>      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> innodb_flush_log_at_timeout <span class="operator">|</span> <span class="number">1</span>        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> innodb_lock_wait_timeout    <span class="operator">|</span> <span class="number">50</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> innodb_rollback_on_timeout  <span class="operator">|</span> OFF      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> interactive_timeout         <span class="operator">|</span> <span class="number">28800</span>    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> lock_wait_timeout           <span class="operator">|</span> <span class="number">31536000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> net_read_timeout            <span class="operator">|</span> <span class="number">30</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> net_write_timeout           <span class="operator">|</span> <span class="number">60</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> slave_net_timeout           <span class="operator">|</span> <span class="number">3600</span>     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> thread_pool_idle_timeout    <span class="operator">|</span> <span class="number">60</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> wait_timeout                <span class="operator">|</span> <span class="number">28800</span>    <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------------------+----------+</span></span><br><span class="line"><span class="number">12</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
<p>wait_timeout 和 interactive_timeout配置的都是八小时的超时时间，此项不是导致问题产生的原因，继续往下看吧。</p>
<h3 id="2-检查mysql-server端状态"><a href="#2-检查mysql-server端状态" class="headerlink" title="2.检查mysql server端状态"></a>2.检查mysql server端状态</h3><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Aborted_clients 由于客户没有正确关闭连接已经死掉，已经放弃的连接数量。 </span><br><span class="line">Aborted_connects 尝试已经失败的MySQL服务器的连接的次数。 </span><br><span class="line">Connections 试图连接MySQL服务器的次数。 </span><br><span class="line">Threads_connected 当前打开的连接的数量。 </span><br><span class="line">Threads_running 不在睡眠的线程数量。 </span><br><span class="line">Uptime 服务器工作了多少秒。</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [(<span class="keyword">none</span>)]<span class="operator">&gt;</span> <span class="keyword">show</span> status <span class="keyword">like</span> <span class="string">&#x27;Threads%&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------+-------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name     <span class="operator">|</span> <span class="keyword">Value</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------+-------+</span></span><br><span class="line"><span class="operator">|</span> Threads_cached    <span class="operator">|</span> <span class="number">16</span>    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Threads_connected <span class="operator">|</span> <span class="number">380</span>   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Threads_created   <span class="operator">|</span> <span class="number">25347</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Threads_running   <span class="operator">|</span> <span class="number">3</span>     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------+-------+</span></span><br><span class="line"><span class="number">4</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MariaDB [(<span class="keyword">none</span>)]<span class="operator">&gt;</span> <span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;thread_cache_size&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------+-------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name     <span class="operator">|</span> <span class="keyword">Value</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------+-------+</span></span><br><span class="line"><span class="operator">|</span> thread_cache_size <span class="operator">|</span> <span class="number">30</span>    <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------+-------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<h3 id="3-检查mysql服务器网络连接状态"><a href="#3-检查mysql服务器网络连接状态" class="headerlink" title="3.检查mysql服务器网络连接状态"></a>3.检查mysql服务器网络连接状态</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">root@ALI-68-95:&#x2F;home&#x2F;developer# netstat -ap|grep 192.168.68.90</span><br><span class="line">tcp        0      0 ALI-68-95:mysql         192.168.68.90:31168     ESTABLISHED 2520&#x2F;mysqld</span><br><span class="line">tcp        0      0 ALI-68-95:mysql         192.168.68.90:36708     ESTABLISHED 2520&#x2F;mysqld</span><br><span class="line">tcp        0      0 ALI-68-95:mysql         192.168.68.90:34118     ESTABLISHED 2520&#x2F;mysqld</span><br><span class="line">tcp        0      0 ALI-68-95:mysql         192.168.68.90:57158     ESTABLISHED 2520&#x2F;mysqld</span><br><span class="line">tcp        0      0 ALI-68-95:mysql         192.168.68.90:37692     ESTABLISHED 2520&#x2F;mysqld</span><br><span class="line">tcp        0      0 ALI-68-95:mysql         192.168.68.90:39896     ESTABLISHED 2520&#x2F;mysqld</span><br><span class="line">tcp        0      0 ALI-68-95:mysql         192.168.68.90:34288     ESTABLISHED 2520&#x2F;mysqld</span><br><span class="line">tcp        0      0 ALI-68-95:mysql         192.168.68.90:36006     ESTABLISHED 2520&#x2F;mysqld</span><br><span class="line">tcp        0      0 ALI-68-95:mysql         192.168.68.90:37960     ESTABLISHED 2520&#x2F;mysqld</span><br><span class="line">tcp        0      0 ALI-68-95:mysql         192.168.68.90:37430     ESTABLISHED 2520&#x2F;mysqld</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<h3 id="4-使用脚本建立mysql连接，模拟客户端请求"><a href="#4-使用脚本建立mysql连接，模拟客户端请求" class="headerlink" title="4.使用脚本建立mysql连接，模拟客户端请求"></a>4.使用脚本建立mysql连接，模拟客户端请求</h3><p>其实最好是使用fpm，把max_children调为1来模拟客户端请求，但是我们开发机同测试环境，nginx和fpm配置不是很方便修改，自己的虚拟机是10网段的也连不上线上的db，所以我们简单用php脚本模拟一下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$_REQUEST</span>[<span class="string">&#x27;serverappenv&#x27;</span>] = <span class="string">&quot;online&quot;</span>;</span><br><span class="line">ini_set(<span class="string">&quot;error_reporting&quot;</span>, E_ALL);</span><br><span class="line">ini_set(<span class="string">&quot;display_errors&quot;</span>, <span class="literal">TRUE</span>);</span><br><span class="line"><span class="keyword">require</span> <span class="keyword">__DIR__</span> . <span class="string">&#x27;/../bootstrap/app.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$connectId</span> = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">while</span> (<span class="variable">$connectId</span>++ &lt; <span class="number">2</span>) &#123;</span><br><span class="line">    <span class="variable">$conn</span> =  \app\connector\mysql\PeanutWrite::getInstance();</span><br><span class="line">    var_dump(<span class="variable">$conn</span>-&gt;pdo-&gt;getAttribute(PDO::ATTR_CONNECTION_STATUS));</span><br><span class="line">    <span class="variable">$conn</span>::<span class="variable">$instance</span> = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    sleep(<span class="number">10</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>脚本运行同时连接mysql查看来自88的连接状态</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [(<span class="keyword">none</span>)]<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> information_schema.processlist <span class="keyword">where</span> host <span class="keyword">like</span> <span class="string">&#x27;192.168.68.88%&#x27;</span>\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           ID: <span class="number">788079</span></span><br><span class="line">         <span class="keyword">USER</span>: xie</span><br><span class="line">         HOST: <span class="number">192.168</span><span class="number">.68</span><span class="number">.88</span>:<span class="number">61470</span></span><br><span class="line">           DB: peanut</span><br><span class="line">      COMMAND: Sleep</span><br><span class="line">         <span class="type">TIME</span>: <span class="number">1</span></span><br><span class="line">        STATE:</span><br><span class="line">         INFO: <span class="keyword">NULL</span></span><br><span class="line">      TIME_MS: <span class="number">1385.269</span></span><br><span class="line">        STAGE: <span class="number">0</span></span><br><span class="line">    MAX_STAGE: <span class="number">0</span></span><br><span class="line">     PROGRESS: <span class="number">0.000</span></span><br><span class="line">  MEMORY_USED: <span class="number">61168</span></span><br><span class="line">EXAMINED_ROWS: <span class="number">0</span></span><br><span class="line">     QUERY_ID: <span class="number">0</span></span><br><span class="line">  INFO_BINARY: <span class="keyword">NULL</span></span><br><span class="line">          TID: <span class="number">847</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">2.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           ID: <span class="number">788078</span></span><br><span class="line">         <span class="keyword">USER</span>: xie</span><br><span class="line">         HOST: <span class="number">192.168</span><span class="number">.68</span><span class="number">.88</span>:<span class="number">61468</span></span><br><span class="line">           DB: <span class="keyword">NULL</span></span><br><span class="line">      COMMAND: Query</span><br><span class="line">         <span class="type">TIME</span>: <span class="number">0</span></span><br><span class="line">        STATE: Filling schema <span class="keyword">table</span></span><br><span class="line">         INFO: <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> information_schema.processlist <span class="keyword">where</span> host <span class="keyword">like</span> <span class="string">&#x27;192.168.68.88%&#x27;</span></span><br><span class="line">      TIME_MS: <span class="number">0.396</span></span><br><span class="line">        STAGE: <span class="number">0</span></span><br><span class="line">    MAX_STAGE: <span class="number">0</span></span><br><span class="line">     PROGRESS: <span class="number">0.000</span></span><br><span class="line">  MEMORY_USED: <span class="number">76616</span></span><br><span class="line">EXAMINED_ROWS: <span class="number">0</span></span><br><span class="line">     QUERY_ID: <span class="number">100217568</span></span><br><span class="line">  INFO_BINARY: <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> information_schema.processlist <span class="keyword">where</span> host <span class="keyword">like</span> <span class="string">&#x27;192.168.68.88%&#x27;</span></span><br><span class="line">          TID: <span class="number">7860</span></span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<p>现象：当sleep(10)时每次循环建立的连接id不变，说明 persistent 生效。</p>
<h2 id="5-把目光转向从库"><a href="#5-把目光转向从库" class="headerlink" title="5.把目光转向从库"></a>5.把目光转向从库</h2><!-- ![image.png](https://i.loli.net/2021/04/28/zP5CTuFgYMeyXUl.png) -->
<p><img src="https://github.com/chenruosong/blog/blob/master/source/image/PdoMysqlPersistent/291F3661-B03E-40AA-AEC6-0B11CB1F6F98.png" alt="image.png"></p>
<!-- ![image.png](https://i.loli.net/2021/04/28/v8KluJa7j2UyYmL.png) -->

<p><img src="https://github.com/chenruosong/blog/blob/master/source/image/PdoMysqlPersistent/893089C7-4599-4D6A-9F88-1FACF3251913.png" alt="image.png"></p>
<p>发现连接的端口号变化频繁，且10上出现多个tcp连接状态为<strong>FIN_WAIT2</strong>,(主动关闭端接到ACK后)；90上则为<strong>CLOSE_WAIT</strong>（被动关闭端TCP接到FIN后，就发出ACK以回应FIN请求(它的接收也作为文件结束符传递给上层应用程序)</p>
<!-- ![image.png](https://i.loli.net/2021/04/28/3aiMD2QxfyWA1Ze.png) -->
<p><img src="https://github.com/chenruosong/blog/blob/master/source/image/PdoMysqlPersistent/3aiMD2QxfyWA1Ze.png" alt="image.png"><br>也就是说90上保存的到10:3333端口haproxy的长连接是被10主动关闭的，接下来我们检查ha的连接断开原因即可。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">root@ALI-68-10:&#x2F;home&#x2F;developer# cat &#x2F;etc&#x2F;haproxy&#x2F;haproxy.cfg</span><br><span class="line">global</span><br><span class="line">	log &#x2F;dev&#x2F;log	local0</span><br><span class="line">	log &#x2F;dev&#x2F;log	local1 notice</span><br><span class="line">	chroot &#x2F;var&#x2F;lib&#x2F;haproxy</span><br><span class="line">	stats socket &#x2F;run&#x2F;haproxy&#x2F;admin.sock mode 660 level admin</span><br><span class="line">	#stats timeout 30s</span><br><span class="line">	stats timeout 3600s</span><br><span class="line">	user haproxy</span><br><span class="line">	group haproxy</span><br><span class="line">	daemon</span><br><span class="line"></span><br><span class="line">	# Default SSL material locations</span><br><span class="line">	ca-base &#x2F;etc&#x2F;ssl&#x2F;certs</span><br><span class="line">	crt-base &#x2F;etc&#x2F;ssl&#x2F;private</span><br><span class="line"></span><br><span class="line">	# Default ciphers to use on SSL-enabled listening sockets.</span><br><span class="line">	# For more information, see ciphers(1SSL). This list is from:</span><br><span class="line">	#  https:&#x2F;&#x2F;hynek.me&#x2F;articles&#x2F;hardening-your-web-servers-ssl-ciphers&#x2F;</span><br><span class="line">	# An alternative list with additional directives can be obtained from</span><br><span class="line">	#  https:&#x2F;&#x2F;mozilla.github.io&#x2F;server-side-tls&#x2F;ssl-config-generator&#x2F;?server&#x3D;haproxy</span><br><span class="line">	ssl-default-bind-ciphers ECDH+AESGCM:DH+AESGCM:ECDH+AES256:DH+AES256:ECDH+AES128:DH+AES:RSA+AESGCM:RSA+AES:!aNULL:!MD5:!DSS</span><br><span class="line">	ssl-default-bind-options no-sslv3</span><br><span class="line"></span><br><span class="line">defaults</span><br><span class="line">	log	global</span><br><span class="line">	mode	http</span><br><span class="line">	option	httplog</span><br><span class="line">	option	dontlognull</span><br><span class="line">        timeout connect 5000</span><br><span class="line"></span><br><span class="line">        #timeout client  50000 # 和客户端保持空闲连接的超时时长</span><br><span class="line">        timeout client  3600s</span><br><span class="line"></span><br><span class="line">        #timeout server  50000 # 和服务端保持空闲连接的超时时长</span><br><span class="line">        timeout server  3600s</span><br><span class="line">	errorfile 400 &#x2F;etc&#x2F;haproxy&#x2F;errors&#x2F;400.http</span><br><span class="line">	errorfile 403 &#x2F;etc&#x2F;haproxy&#x2F;errors&#x2F;403.http</span><br><span class="line">	errorfile 408 &#x2F;etc&#x2F;haproxy&#x2F;errors&#x2F;408.http</span><br><span class="line">	errorfile 500 &#x2F;etc&#x2F;haproxy&#x2F;errors&#x2F;500.http</span><br><span class="line">	errorfile 502 &#x2F;etc&#x2F;haproxy&#x2F;errors&#x2F;502.http</span><br><span class="line">	errorfile 503 &#x2F;etc&#x2F;haproxy&#x2F;errors&#x2F;503.http</span><br><span class="line">	errorfile 504 &#x2F;etc&#x2F;haproxy&#x2F;errors&#x2F;504.http</span><br><span class="line">listen mysql</span><br><span class="line">        bind  0.0.0.0:3333</span><br><span class="line">        mode tcp</span><br><span class="line">        option  tcplog</span><br><span class="line">        #balance roundrobin</span><br><span class="line">        acl allow_1  src 192.168.0.0&#x2F;16</span><br><span class="line">        acl allow_2  src 10.10.248.0&#x2F;24</span><br><span class="line">        tcp-request content  accept if allow_1</span><br><span class="line">        tcp-request content  accept if allow_2</span><br><span class="line">        tcp-request content  reject</span><br><span class="line">        balance leastconn</span><br><span class="line">        server mysql_96 192.168.68.96:3306 weight 1 check port 3306 inter 10s rise 2 fall 2 maxconn 600</span><br><span class="line">        server mysql_97 192.168.68.97:3306 weight 1 check port 3306 inter 10s rise 2 fall 2 maxconn 600</span><br><span class="line">        #option tcpka</span><br></pre></td></tr></table></figure>
<p>其中将timeout client/server 为空闲连接的超时时长，单位为毫秒 50000也就是50s，怀疑是一个php-fpm worker进程上的到mysql从库的ha连接空闲50后断开，但是PDO长连接不知道，在首次new PDO对象时依然使用旧连接，导致报出warning：mysql gone away，改为3600s后：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@ALI-68-10:&#x2F;home&#x2F;developer#  netstat -nat |grep &#39;192.168.68.90&#39;|awk &#39;&#123;print $6&#125;&#39;|sort|uniq -c</span><br><span class="line">    159 ESTABLISHED</span><br></pre></td></tr></table></figure>
<p>问题解决。</p>
<h2 id="四、后续"><a href="#四、后续" class="headerlink" title="四、后续"></a>四、后续</h2><p>目前我们线上服务器的一些设置</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [(<span class="keyword">none</span>)]<span class="operator">&gt;</span> <span class="keyword">show</span> variables <span class="keyword">like</span> &quot;max_connections%&quot;;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+-------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name   <span class="operator">|</span> <span class="keyword">Value</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+-------+</span></span><br><span class="line"><span class="operator">|</span> max_connections <span class="operator">|</span> <span class="number">1000</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+-------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">developer@ALI-68-90:~$ cat &#x2F;etc&#x2F;php&#x2F;7.0&#x2F;fpm&#x2F;pool.d&#x2F;www.conf|grep child</span><br><span class="line">;修改了php7的最大child</span><br><span class="line">pm.max_children &#x3D; 150</span><br></pre></td></tr></table></figure>
<p>在只有两台fpm的情况下最大空闲长连接数理论上可以达到300，现阶段qps不高但情况下一台get机常驻50个php-fpm子进程是没问题的，但想象一下，如果我们扩展到10台php服务器，每台服务器都是100+的子进程，一旦达到mysql最大连接数，就会造成too many   connections的问题，且空闲连接数过多也会增加mysql服务器的压力。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://chenruosong.com/2021/04/26/%E4%B8%80%E6%AC%A1%E7%BA%BF%E4%B8%8AMysql-has-gone-away%E6%8E%92%E6%9F%A5%E8%AE%B0%E5%BD%95/" data-id="cknxzxyr00000rvbf3kao3w9d" data-title="Pdo长连接导致Mysql has gone away排查记录" class="article-share-link">分享</a>
      
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2021/04/28/%E6%9C%8D%E5%8A%A1%E7%AB%AF%E7%9B%91%E6%8E%A7%E6%96%B9%E6%A1%88%E8%B0%83%E7%A0%94/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">前一篇</strong>
      <div class="article-nav-title">
        
          服务端监控方案调研
        
      </div>
    </a>
  
  
    <a href="/2021/04/19/Netty-%E6%A0%B8%E5%BF%83%E7%BB%84%E4%BB%B6/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">后一篇</strong>
      <div class="article-nav-title">Netty 核心组件</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/05/">五月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/04/">四月 2021</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2021/05/14/Kafka-ZooKeeper/">Kafka/ZooKeeper</a>
          </li>
        
          <li>
            <a href="/2021/05/12/shell-%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/">shell 常用命令</a>
          </li>
        
          <li>
            <a href="/2021/05/10/ELK-Zabbix-%E9%83%A8%E7%BD%B2/">ELK + kafka +Zabbix 部署</a>
          </li>
        
          <li>
            <a href="/2021/04/28/%E6%9C%8D%E5%8A%A1%E7%AB%AF%E7%9B%91%E6%8E%A7%E6%96%B9%E6%A1%88%E8%B0%83%E7%A0%94/">服务端监控方案调研</a>
          </li>
        
          <li>
            <a href="/2021/04/26/%E4%B8%80%E6%AC%A1%E7%BA%BF%E4%B8%8AMysql-has-gone-away%E6%8E%92%E6%9F%A5%E8%AE%B0%E5%BD%95/">Pdo长连接导致Mysql has gone away排查记录</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2021 Chen<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>