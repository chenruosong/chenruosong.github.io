<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"chenruosong.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="凉凉的超人">
<meta property="og:url" content="http://chenruosong.com/">
<meta property="og:site_name" content="凉凉的超人">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Chen">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://chenruosong.com/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>凉凉的超人</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">凉凉的超人</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://chenruosong.com/2021/05/14/Kafka-ZooKeeper/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Chen">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="凉凉的超人">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/05/14/Kafka-ZooKeeper/" class="post-title-link" itemprop="url">Kafka/ZooKeeper</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-05-14 16:19:49" itemprop="dateCreated datePublished" datetime="2021-05-14T16:19:49+08:00">2021-05-14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-17 14:56:20" itemprop="dateModified" datetime="2021-05-17T14:56:20+08:00">2021-05-17</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="一、消息队列-Message-Queue"><a href="#一、消息队列-Message-Queue" class="headerlink" title="一、消息队列 Message Queue"></a>一、消息队列 Message Queue</h1>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://chenruosong.com/2021/05/12/shell-%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Chen">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="凉凉的超人">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/05/12/shell-%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/" class="post-title-link" itemprop="url">shell 常用命令</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-05-12 15:05:32" itemprop="dateCreated datePublished" datetime="2021-05-12T15:05:32+08:00">2021-05-12</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-14 15:41:20" itemprop="dateModified" datetime="2021-05-14T15:41:20+08:00">2021-05-14</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>#文件比较符<br>-e 判断对象是否存在<br>-d 判断对象是否存在，并且为目录<br>-f 判断对象是否存在，并且为常规文件<br>-L 判断对象是否存在，并且为符号链接<br>-h 判断对象是否存在，并且为软链接<br>-s 判断对象是否存在，并且长度不为0<br>-r 判断对象是否存在，并且可读<br>-w 判断对象是否存在，并且可写<br>-x 判断对象是否存在，并且可执行<br>-O 判断对象是否存在，并且属于当前用户<br>-G 判断对象是否存在，并且属于当前用户组<br>-nt 判断file1是否比file2新  [ “/data/file1” -nt “/data/file2” ]<br>-ot 判断file1是否比file2旧  [ “/data/file1” -ot “/data/file2” ]</p>
<h2 id="查看内存映射"><a href="#查看内存映射" class="headerlink" title="查看内存映射"></a>查看内存映射</h2><p>cat /proc/PID/maps 或 cat /proc/PID/smaps</p>
<h2 id="查看系统调用"><a href="#查看系统调用" class="headerlink" title="查看系统调用"></a>查看系统调用</h2><p>strace</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://chenruosong.com/2021/05/10/ELK-Zabbix-%E9%83%A8%E7%BD%B2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Chen">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="凉凉的超人">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/05/10/ELK-Zabbix-%E9%83%A8%E7%BD%B2/" class="post-title-link" itemprop="url">ELK + kafka +Zabbix 部署</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-05-10 18:24:52" itemprop="dateCreated datePublished" datetime="2021-05-10T18:24:52+08:00">2021-05-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-19 15:51:04" itemprop="dateModified" datetime="2021-05-19T15:51:04+08:00">2021-05-19</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>#ELK<br><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elastic-stack-get-started/current/get-started-elastic-stack.html#deb">https://www.elastic.co/guide/en/elastic-stack-get-started/current/get-started-elastic-stack.html#deb</a></p>
<p>#kafka</p>
<h2 id="jdk"><a href="#jdk" class="headerlink" title="jdk"></a>jdk</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install default-jdk</span><br><span class="line">export JAVA_HOME&#x3D;&#x2F;usr&#x2F;lib&#x2F;jvm&#x2F;java-7-openjdk-amd64</span><br><span class="line">export PATH&#x3D;$PATH:$JAVA_HOME&#x2F;bin</span><br></pre></td></tr></table></figure>

<h2 id="zookeeper"><a href="#zookeeper" class="headerlink" title="zookeeper"></a>zookeeper</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget https:&#x2F;&#x2F;mirrors.bfsu.edu.cn&#x2F;apache&#x2F;zookeeper&#x2F;zookeeper-3.6.3&#x2F;apache-zookeeper-3.6.3.tar.gz</span><br><span class="line">tar -zxvf apache-zookeeper-3.6.3.tar.gz</span><br><span class="line">cp zoo_sample.cfg zoo.cfg</span><br><span class="line">bin&#x2F;zkServer.sh start</span><br></pre></td></tr></table></figure>
<p>此时报错</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">zkServer.sh: 78: /opt/apache-zookeeper-3.6.3/bin/zkEnv.sh: [[: not found</span><br><span class="line">-p: not found</span><br><span class="line">java is /usr/bin/java</span><br><span class="line">Error: JAVA_HOME is not set and java could not be found in PATH.</span><br></pre></td></tr></table></figure>
<p>尝试./zkServer.sh start-foreground命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">ZooKeeper JMX enabled by default</span><br><span class="line">Using config: &#x2F;opt&#x2F;apache-zookeeper-3.6.3-bin&#x2F;bin&#x2F;..&#x2F;conf&#x2F;zoo.cfg</span><br><span class="line">Exception in thread &quot;main&quot; java.lang.UnsupportedClassVersionError: org&#x2F;apache&#x2F;zookeeper&#x2F;server&#x2F;quorum&#x2F;QuorumPeerMain : Unsupported major.minor version 52.0</span><br><span class="line">	at java.lang.ClassLoader.defineClass1(Native Method)</span><br><span class="line">	at java.lang.ClassLoader.defineClass(ClassLoader.java:808)</span><br><span class="line">	at java.security.SecureClassLoader.defineClass(SecureClassLoader.java:142)</span><br><span class="line">	at java.net.URLClassLoader.defineClass(URLClassLoader.java:443)</span><br><span class="line">	at java.net.URLClassLoader.access$100(URLClassLoader.java:65)</span><br><span class="line">	at java.net.URLClassLoader$1.run(URLClassLoader.java:355)</span><br><span class="line">	at java.net.URLClassLoader$1.run(URLClassLoader.java:349)</span><br><span class="line">	at java.security.AccessController.doPrivileged(Native Method)</span><br><span class="line">	at java.net.URLClassLoader.findClass(URLClassLoader.java:348)</span><br><span class="line">	at java.lang.ClassLoader.loadClass(ClassLoader.java:430)</span><br><span class="line">	at sun.misc.Launcher$AppClassLoader.loadClass(Launcher.java:326)</span><br><span class="line">	at java.lang.ClassLoader.loadClass(ClassLoader.java:363)</span><br><span class="line">	at sun.launcher.LauncherHelper.checkAndLoadMain(LauncherHelper.java:482)</span><br></pre></td></tr></table></figure>
<p>原因：jdk版本过低，需要1.8以上，故升级jdk</p>
<h1 id="root-vps-10-10-248-55-in-opt-apache-zookeeper-3-6-3-bin-bin-8-13-19"><a href="#root-vps-10-10-248-55-in-opt-apache-zookeeper-3-6-3-bin-bin-8-13-19" class="headerlink" title="root @ vps-10-10-248-55 in /opt/apache-zookeeper-3.6.3-bin/bin [8:13:19]"></a>root @ vps-10-10-248-55 in /opt/apache-zookeeper-3.6.3-bin/bin [8:13:19]</h1><p>$ whereis java<br>java: /usr/bin/java /usr/share/java /usr/lib/jvm/java-7-openjdk-amd64/bin/java /usr/share/man/man1/java.1.gz</p>
<h1 id="root-vps-10-10-248-55-in-opt-apache-zookeeper-3-6-3-bin-bin-8-15-03"><a href="#root-vps-10-10-248-55-in-opt-apache-zookeeper-3-6-3-bin-bin-8-15-03" class="headerlink" title="root @ vps-10-10-248-55 in /opt/apache-zookeeper-3.6.3-bin/bin [8:15:03]"></a>root @ vps-10-10-248-55 in /opt/apache-zookeeper-3.6.3-bin/bin [8:15:03]</h1><p>$ whereis javac<br>javac: /usr/bin/javac /usr/lib/jvm/java-7-openjdk-amd64/bin/javac /usr/share/man/man1/javac.1.gz<br>rm -rf /usr/lib/jvm/java-7-openjdk-amd64<br>wget –no-check-certificate –no-cookies –header “Cookie: oraclelicense=accept-securebackup-cookie”  <a target="_blank" rel="noopener" href="http://download.oracle.com/otn-pub/java/jdk/8u131-b11/d54c1d3a095b4ff2b6607d096fa80163/jdk-8u131-linux-x64.tar.gz">http://download.oracle.com/otn-pub/java/jdk/8u131-b11/d54c1d3a095b4ff2b6607d096fa80163/jdk-8u131-linux-x64.tar.gz</a></p>
<h2 id="lnmp环境"><a href="#lnmp环境" class="headerlink" title="lnmp环境"></a>lnmp环境</h2><p>/home/opdir/logstash-5.6.3/config/shiper_claw_user_cancel.conf</p>
<p>  389  apt-get install filebeat=6.3.2<br>  390  cat /etc/filebeat/filebeat.yml<br>  391  /etc/init.d/filebeat start<br>  392  tail /var/log/filebeat/filebeat</p>
<pre><code>398  tar xvf filebeat-6.3.2-linux-x86_64.tar.gz
</code></pre>
<p>  399  mv filebeat-6.3.2-linux-x86_64 filebeat-6.3.2<br>  400  cd filebeat-6.3.2/</p>
<p>  mkdir config<br>  403  cd config/<br>  404  cp /etc/filebeat/filebeat.yml indexer_kafka_maozhua_syslog.yml<br>  405  cd ../<br>  406  /etc/init.d/filebeat stop<br>  407  ps aux|grep filebeat<br>  408  ./filebeat -c config/indexer_kafka_maozhua_syslog.yml &amp;<br>  409  tail /var/log/filebeat/filebeat</p>
<p>  /home/opdir/elasticsearch-5.2.0/<br>  /home/opdir/filebeat-6.3.2/config/indexer_kafka_maozhua_access_log_and_syslog.yml<br>  /etc/zabbix</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://chenruosong.com/2021/04/28/%E6%9C%8D%E5%8A%A1%E7%AB%AF%E7%9B%91%E6%8E%A7%E6%96%B9%E6%A1%88%E8%B0%83%E7%A0%94/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Chen">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="凉凉的超人">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/04/28/%E6%9C%8D%E5%8A%A1%E7%AB%AF%E7%9B%91%E6%8E%A7%E6%96%B9%E6%A1%88%E8%B0%83%E7%A0%94/" class="post-title-link" itemprop="url">服务端监控方案调研</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-04-28 17:03:51" itemprop="dateCreated datePublished" datetime="2021-04-28T17:03:51+08:00">2021-04-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-13 17:11:30" itemprop="dateModified" datetime="2021-05-13T17:11:30+08:00">2021-05-13</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="一、需求背景"><a href="#一、需求背景" class="headerlink" title="一、需求背景"></a>一、需求背景</h1><h2 id="线上环境服务端架构一览："><a href="#线上环境服务端架构一览：" class="headerlink" title="线上环境服务端架构一览："></a>线上环境服务端架构一览：</h2><table>
<thead>
<tr>
<th>项目</th>
<th align="right">数量</th>
<th align="center">描述</th>
</tr>
</thead>
<tbody><tr>
<td>前端机</td>
<td align="right">1</td>
<td align="center"></td>
</tr>
<tr>
<td>get机</td>
<td align="right">2</td>
<td align="center">php-fpm</td>
</tr>
<tr>
<td>mysql主</td>
<td align="right">1</td>
<td align="center"></td>
</tr>
<tr>
<td>mysql从</td>
<td align="right">2</td>
<td align="center"></td>
</tr>
<tr>
<td>redis主</td>
<td align="right">1</td>
<td align="center"></td>
</tr>
<tr>
<td>redis从</td>
<td align="right">1</td>
<td align="center"></td>
</tr>
<tr>
<td>memcache</td>
<td align="right">2</td>
<td align="center"></td>
</tr>
<tr>
<td>nsq</td>
<td align="right">1</td>
<td align="center"></td>
</tr>
<tr>
<td>haproxy</td>
<td align="right">1</td>
<td align="center"></td>
</tr>
<tr>
<td>websocker</td>
<td align="right">1</td>
<td align="center">4节点</td>
</tr>
</tbody></table>
<h2 id="主要监控指标确立"><a href="#主要监控指标确立" class="headerlink" title="主要监控指标确立"></a>主要监控指标确立</h2><p>谷歌针对分布式系统监控的经验总结，四个黄金信号（Four Golden Signals）。它指的是，在服务层面一般需要监控四个指标，分别是延迟，通信量、错误和饱和度。<br>延迟指的是请求的响应时间。比如，接口的响应时间、访问数据库和缓存的响应时间。</p>
<p>通信量可以理解为吞吐量，也就是单位时间内，请求量的大小。比如，访问第三方服务的请求量，访问消息队列的请求量。</p>
<p>错误表示当前系统发生的错误数量。这里需要注意的是， 我们需要监控的错误既有显示的，比如在监控 Web 服务时，出现 4xx 和 5xx 的响应码；也有隐示的，比如，Web服务虽然返回的响应码是 200，但是却发生了一些和业务相关的错误，这些都是错误的范畴。</p>
<p>饱和度指的是服务或者资源到达上限的程度（也可以说是服务或者资源的利用率），比如说 CPU 的使用率，内存使用率，磁盘使用率，缓存数据库的连接数等等。</p>
<p>总结：</p>
<ol>
<li>功能监控：能够及时的发现线上的bug，异常。</li>
<li>性能监控：能够量化服务的性能指标。</li>
<li>状态监控：能够实时查看、回溯机器、服务(mysql、redis、nginx等)状态，定位异常，辅助分析。</li>
<li>报警功能：自定义阈值，自动化报警。<br>……</li>
</ol>
<h1 id="二、主流监控方案分析"><a href="#二、主流监控方案分析" class="headerlink" title="二、主流监控方案分析"></a>二、主流监控方案分析</h1><h2 id="ELK-和-EFK"><a href="#ELK-和-EFK" class="headerlink" title="ELK 和 EFK"></a>ELK 和 EFK</h2><ul>
<li>Elasticsearch 是一个集中存储 log 的地方，更重要的是它是一个全文检索以及分析的引擎，它能让用户以近乎实时的方式来查看、分析海量的数据。</li>
<li>Logstash 是一个用来搜集、分析、过滤日志的工具。</li>
<li>Kibana 是一个基于 Web 的图形界面，用于搜索、分析和可视化存储在 Elasticsearch 指标中的日志数据。</li>
</ul>
<p>由于 Logstash是在jvm上运行的。基于此，Elastic 发布了 beats 系列轻量级采集组件。</p>
<ul>
<li><p>Fluentd 是另一个 Ruby 语言编写的日志收集系统。和 Logstash 不同的是，Fluentd 是基于 MRI 实现的，并不是利用多线程，而是利用事件驱动。</p>
</li>
<li><p>FileBeat:Beats 是一系列轻量型的单一功能数据采集器，可以直接写入 Elasticsearch，也可以传输给 Logstash. Filebeat 是基于原先 logstash-forwarder 的源码改造出来的。换句话说：filebeat 就是新版的 logstash-forwarder，也会是 Elastic Stack 在 shipper 端的第一选择。</p>
</li>
</ul>
<h2 id="Grafana"><a href="#Grafana" class="headerlink" title="Grafana"></a>Grafana</h2><blockquote>
<p>Grafana是一个开源的度量分析与可视化套件，通俗的说，Grafana就是一个图形可视化展示平台，它通过各种炫酷的界面效果展示我们的监控数据，Grafana支持许多不同的数据源，Graphite，InfluxDB，OpenTSDB，Prometheus，Elasticsearch，CloudWatch和KairosDB都可以完美支持。</p>
</blockquote>
<h2 id="grafana和kibana"><a href="#grafana和kibana" class="headerlink" title="grafana和kibana"></a>grafana和kibana</h2><blockquote>
<ul>
<li>Grafana更适合需要连续实时监控指标（例如CPU负载，内存等）的应用程序。</li>
<li>Kibana更适合于日志文件分析和全文本搜索查询。</li>
</ul>
</blockquote>
<h2 id="Nagios"><a href="#Nagios" class="headerlink" title="Nagios"></a>Nagios</h2><blockquote>
<p>Nagios是一款开源的免费网络监视工具，能有效监控Windows、Linux和Unix的主机状态，交换机路由器等网络设置，打印机等。在系统或服务状态异常时发出邮件或短信报警第一时间通知网站运维人员，在状态恢复后发出正常的邮件或短信通知。<br>Nagios主要的特征是监控告警，最强大的就是告警功能，可支持多种告警方式，但缺点是没有强大的数据收集机制，并且数据出图也很简陋，当监控的主机越来越多时，添加主机也非常麻烦，配置文件都是基于文本配置的，不支持web方式管理和配置，这样很容易出错，不宜维护。</p>
</blockquote>
<h2 id="Zabbix"><a href="#Zabbix" class="headerlink" title="Zabbix"></a>Zabbix</h2><blockquote>
<p>zabbix是一个基于WEB界面的提供分布式系统监视以及网络监视功能的企业级的开源解决方案。zabbix能监视各种网络参数，保证服务器系统的安全运营；并提供强大的通知机制以让系统运维人员快速定位/解决存在的各种问题。<br>zabbix由2部分构成，zabbix server与可选组件zabbix agent。zabbix server可以通过SNMP，zabbix agent，ping，端口监视等方法提供对远程服务器/网络状态的监视，数据收集等功能，它可以运行在Linux, Solaris, HP-UX, AIX, Free BSD, Open BSD, OS X等平台上。</p>
</blockquote>
<blockquote>
<p>zabbix解决了cacti没有告警的不足，也解决了nagios不能通过web配置的缺点，同时还支持分布式部署，这使得它迅速流行起来，zabbix也成为目前中小企业监控最流行的运维监控平台。<br>当然，zabbix也有不足之处，它消耗的资源比较多，如果监控的主机非常多时，可能会出现监控超时、告警超时等现象，使用了关系型数据存储时序数据，所以在监控大规模集群时常常在数据存储方面捉襟见肘。</p>
</blockquote>
<h2 id="Prometheus"><a href="#Prometheus" class="headerlink" title="Prometheus"></a>Prometheus</h2><blockquote>
<p>Prometheus是一套开源的系统监控报警框架，它既适用于面向服务器等硬件指标的监控，也适用于高动态的面向服务架构的监控。对于现在流行的微服务，Prometheus的多维度数据收集和数据筛选查询语言也是非常的强大。Prometheus是为服务的可靠性而设计的，当服务出现故障时，它可以使你快速定位和诊断问题。</p>
</blockquote>
<h1 id="三、方案对比"><a href="#三、方案对比" class="headerlink" title="三、方案对比"></a>三、方案对比</h1><h2 id="Zabbix-和-Prometheus"><a href="#Zabbix-和-Prometheus" class="headerlink" title="Zabbix 和 Prometheus"></a>Zabbix 和 Prometheus</h2><ol>
<li>从<strong>数据存储</strong>方面看，Zabbix 采用关系数据库保存，这极大限制了 Zabbix 采集的性能，而 Prometheus 自研一套高性能的时序数据库，在 V3 版本可以达到每秒千万级别的数据存储，通过对接第三方时序数据库扩展历史数据的存储；</li>
<li>从<strong>容器支持</strong>角度看，Prometheus 的动态发现机制，不仅可以支持 swarm 原生集群，还支持 Kubernetes 容器集群的监控，是目前容器监控最好解决方案。Zabbix 在传统监控系统中，尤其是在服务器相关监控方面，占据绝对优势。</li>
<li><strong>企业应用</strong> 基本上使用kubernetes与容器的企业，prometheus是最好的选择，在传统监控系统中，尤其是在服务器相关监控方面，zabbix占据绝对优势</li>
</ol>
<table>
<thead>
<tr>
<th align="right">Zabbix</th>
<th align="center">Prometheus</th>
</tr>
</thead>
<tbody><tr>
<td align="right">后端用 C 开发，界面用 PHP 开发，定制化难度很高。</td>
<td align="center">后端用 golang 开发，前端是 Grafana，JSON 编辑即可解决。定制化难度较低.</td>
</tr>
<tr>
<td align="right">集群规模上限为 10000 个节点。</td>
<td align="center">支持更大的集群规模，速度也更快。</td>
</tr>
<tr>
<td align="right">更适合监控物理机环境。</td>
<td align="center">更适合云环境的监控，对 OpenStack，Kubernetes 有更好的集成。</td>
</tr>
<tr>
<td align="right">监控数据存储在关系型数据库内，如 MySQL，很难从现有数据中扩展维度。</td>
<td align="center">监控数据存储在基于时间序列的数据库内，便于对已有数据进行新的聚合。</td>
</tr>
<tr>
<td align="right">安装简单，zabbix-server 一个软件包中包括了所有的服务端功能。</td>
<td align="center">安装相对复杂，监控、告警和界面都分属于不同的组件。</td>
</tr>
<tr>
<td align="right">图形化界面比较成熟，界面上基本上能完成全部的配置操作。</td>
<td align="center">界面相对较弱，很多配置需要修改配置文件。</td>
</tr>
<tr>
<td align="right">发展时间更长，对于很多监控场景，都有现成的解决方案。</td>
<td align="center">2015 年后开始快速发展，但发展时间较短，成熟度不及 Zabbix。</td>
</tr>
</tbody></table>
<h2 id="Zabbix-和-ELK"><a href="#Zabbix-和-ELK" class="headerlink" title="Zabbix 和 ELK"></a>Zabbix 和 ELK</h2><blockquote>
<p>关于日志收集，其实Zabbix也可以，但是像做到Elastic公司这么大的成套程序的且具有一定社群基础的情况下，Zabbix定位为一个监控告警程序显然在日志收集方面有些鸡肋。</p>
</blockquote>
<p>我还在elastic官方文档中找到这么一款产品：X-Pack</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">X-Pack是Elastic Stack扩展，它将安全性，警报，监视，报告和图形功能捆绑到一个易于安装的程序包中。X-Pack组件旨在无缝地协同工作，但是您可以轻松地启用或禁用要使用的功能。</span><br></pre></td></tr></table></figure>
<p>但是只支持6.2以下版本的，且相关文档少之又少，貌似还是付费的，这里就不继续研究了。</p>
<h1 id="四、总结"><a href="#四、总结" class="headerlink" title="四、总结"></a>四、总结</h1><p>ELK Stack中的logstash有Zabbix相关插件(Zabbix Output Plugin)，说明这个玩意跟ELK如果很好的利用起来的话，是能够建起来一个具有生产力的日志集中分析与告警集中监控平台的。<br>至此，一个基于elk和zabbix的服务端监控+报警系统的框架雏形已经基本定了：<br><img src="https://i.loli.net/2021/05/08/3GzdqBLbYsh8lQK.jpg" alt="WechatIMG97.jpeg"></p>
<p>以上架构需要</p>
<ol>
<li>一台机器运行<br>es + logstash 依赖环境：jdk<br>zabbix server 依赖环境：lnmp<br>硬件资源配置参考    </li>
</ol>
<table>
<thead>
<tr>
<th>规模</th>
<th align="right">平台</th>
<th align="right">CPU/内存</th>
<th align="right">数据库</th>
<th align="right">受监控的主机数量</th>
</tr>
</thead>
<tbody><tr>
<td>小型</td>
<td align="right">CentOS</td>
<td align="right">Virtual Appliance</td>
<td align="right">MySQL InnoDB</td>
<td align="right">100</td>
</tr>
<tr>
<td>中型</td>
<td align="right">CentOS</td>
<td align="right">2 CPU cores/2GB</td>
<td align="right">MySQL InnoDB</td>
<td align="right">500</td>
</tr>
<tr>
<td>大型</td>
<td align="right">RedHat Enterprise Linux</td>
<td align="right">4 CPU cores/8GB</td>
<td align="right">RAID10 MySQL InnoDB 或 PostgreSQL</td>
<td align="right">&gt;1000</td>
</tr>
<tr>
<td>极大型</td>
<td align="right">RedHat Enterprise Linux</td>
<td align="right">8 CPU cores/16GB</td>
<td align="right">Fast RAID10 MySQL InnoDB 或 PostgreSQL</td>
<td align="right">&gt;10000</td>
</tr>
</tbody></table>
<ol start="2">
<li>所有host需要安装运行beats + zabbix agent</li>
</ol>
<h1 id="五、问题思考"><a href="#五、问题思考" class="headerlink" title="五、问题思考"></a>五、问题思考</h1><h2 id="1-ELK-zabbix-beats-agent的自动化部署"><a href="#1-ELK-zabbix-beats-agent的自动化部署" class="headerlink" title="1.ELK+zabbix / beats + agent的自动化部署"></a>1.ELK+zabbix / beats + agent的自动化部署</h2><pre><code>借助spug批量化执行sh脚本，可尽量避免人工操作，保证环境一致性    
</code></pre>
<h2 id="2-zabbix-server性能瓶颈、性能调优以及拓展方案"><a href="#2-zabbix-server性能瓶颈、性能调优以及拓展方案" class="headerlink" title="2.zabbix server性能瓶颈、性能调优以及拓展方案"></a>2.zabbix server性能瓶颈、性能调优以及拓展方案</h2><pre><code>当主机和监控项达到一定数量zabbix会出现性能上的瓶颈，可优化项包括：   
</code></pre>
<ul>
<li>仅监控所需参数</li>
<li>调整所有项目的“更新间隔”。 保持较小的更新间隔对于漂亮的图形可能是好的，但是这可能会超载Zabbix</li>
<li>调整默认模板的参数</li>
<li>调整housekeeping参数</li>
<li>不监视返回相同信息的参数。</li>
<li>避免使用长期给出的触发器作为函数参数。 例如，max（3600）的计算速度明显比max（60）慢。   </li>
</ul>
<h2 id="3-Zabbix-Active-agent自动注册、动态拓展？"><a href="#3-Zabbix-Active-agent自动注册、动态拓展？" class="headerlink" title="3.Zabbix Active agent自动注册、动态拓展？"></a>3.Zabbix Active agent自动注册、动态拓展？</h2><h2 id="4-如何保证监控服务的高可用？"><a href="#4-如何保证监控服务的高可用？" class="headerlink" title="4.如何保证监控服务的高可用？"></a>4.如何保证监控服务的高可用？</h2><p>zabbix集群，keepalived做主备切换，避免单点故障<br>mysql主从同步</p>
<h2 id="5-kafka-在整个流程中的必要性？"><a href="#5-kafka-在整个流程中的必要性？" class="headerlink" title="5.kafka 在整个流程中的必要性？"></a>5.kafka 在整个流程中的必要性？</h2><p>Logstash消耗系统资源比较大，运行时占用CPU和内存资源较高，没有消息队列缓存，可能存在数据丢失的风险。<br>为保证日志传输数据的可靠性和稳定性，引入Kafka作为消息缓冲队列，位于各个节点上的beats先将数据传递给消息队列，接着，Logstash将格式化的数据传递给Elasticsearch进行存储。由于引入了Kafka缓冲机制，即使远端Logstash server因故障停止运行，数据也不会丢失，可靠性得到了大大的提升。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://chenruosong.com/2021/04/26/%E4%B8%80%E6%AC%A1%E7%BA%BF%E4%B8%8AMysql-has-gone-away%E6%8E%92%E6%9F%A5%E8%AE%B0%E5%BD%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Chen">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="凉凉的超人">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/04/26/%E4%B8%80%E6%AC%A1%E7%BA%BF%E4%B8%8AMysql-has-gone-away%E6%8E%92%E6%9F%A5%E8%AE%B0%E5%BD%95/" class="post-title-link" itemprop="url">Pdo长连接导致Mysql has gone away排查记录</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-04-26 09:31:16" itemprop="dateCreated datePublished" datetime="2021-04-26T09:31:16+08:00">2021-04-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-04-28 17:14:51" itemprop="dateModified" datetime="2021-04-28T17:14:51+08:00">2021-04-28</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="一、背景描述"><a href="#一、背景描述" class="headerlink" title="一、背景描述"></a>一、背景描述</h2><p>线上环境nginx errorlog频繁输出以下日志  </p>
<ul>
<li><code>2021/04/26 09:32:07 [error] 12202#12202: *4270291 FastCGI sent in stderr: &quot;PHP message: PHP Warning:  PDO::__construct(): MySQL server has gone away in /xxx/PdoConn.php on line 57&quot; while reading response header from upstream, client: xxx, server: xxx.com, request ......</code></li>
</ul>
<p>几个疑惑点</p>
<ul>
<li>warning是在new Pdo对象时抛出的(app/connector/mysql/PdoConn.php:57)<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">$this</span>-&gt;pdo = <span class="keyword">new</span> PDO(<span class="variable">$dsn</span>, <span class="keyword">$this</span>-&gt;config[<span class="string">&quot;username&quot;</span>], <span class="keyword">$this</span>-&gt;config[<span class="string">&quot;password&quot;</span>], <span class="keyword">array</span>(PDO::ATTR_PERSISTENT =&gt; <span class="literal">true</span>));</span><br></pre></td></tr></table></figure></li>
<li>(主库68.95:3306,伏笔) netstat查看php worker机(90/91)到mysqld的连接端口,相隔一段时间内并没有变化，且Threads_created没有增长，说明没有建立新的连接</li>
</ul>
<p>首先经过简单的日志分析配合抓包发现：</p>
<ul>
<li>该warning基本覆盖大部分请求,非特定接口导致</li>
<li>复现概率较高，但不是必现</li>
<li>不影响正常业务逻辑，接口能正常响应，返回数据（ping+重连？）</li>
</ul>
<h2 id="二、问题分析"><a href="#二、问题分析" class="headerlink" title="二、问题分析"></a>二、问题分析</h2><h3 id="Mysql-has-gone-away"><a href="#Mysql-has-gone-away" class="headerlink" title="Mysql has gone away"></a><strong>Mysql has gone away</strong></h3><p>首先根据 <a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/8.0/en/gone-away.html">mysql官方文档</a> 找出可能导致抛出<code>MySQL server has gone away</code>的原因有：  </p>
<p>The most common reason for the MySQL server has gone away error is that <strong>the server timed out and closed the connection</strong>. In this case, you normally get one of the following error codes (which one you get is operating system-dependent).</p>
<p>Some other common reasons for the MySQL server has gone away error are:</p>
<ol>
<li><p>You (or the db administrator) has <strong>killed</strong> the running thread with a KILL statement or a mysqladmin kill command. (x)</p>
</li>
<li><p>You tried to run a <strong>query</strong> after closing the connection to the server. This indicates a logic error in the application that should be corrected. (x)</p>
</li>
<li><p>A client application running on a different host does not have the necessary <strong>privileges</strong> to connect to the MySQL server from that host. (x)</p>
</li>
<li><p>You got a <strong>timeout from the TCP/IP connection</strong> on the client side. This may happen if you have been using the commands: mysql_options(…, MYSQL_OPT_READ_TIMEOUT,…) or mysql_options(…, MYSQL_OPT_WRITE_TIMEOUT,…). In this case increasing the timeout may help solve the problem.(x)</p>
</li>
<li><p>You have encountered a timeout on the server side and the automatic reconnection in the client is disabled (the reconnect flag in the MYSQL structure is equal to 0). (?)</p>
</li>
<li><p>You are using a Windows client and the server had dropped the connection (probably because <strong>wait_timeout</strong> expired) before the command was issued.</p>
</li>
<li><p>The problem on Windows is that in some cases MySQL does not get an error from the OS when writing to the TCP/IP connection to the server, but instead gets the error when trying to read the answer from the connection.</p>
</li>
<li><p>The solution to this is to either do a mysql_ping() on the connection if there has been a long time since the last query (this is what Connector/ODBC does) or set <strong>wait_timeout</strong> on the mysqld server so high that it in practice never times out.</p>
</li>
<li><p>You can also get these errors if you send a query to the server that is <strong>incorrect or too large</strong>. If mysqld receives a packet that is too large or out of order, it assumes that something has gone wrong with the client and closes the connection. If you need big queries (for example, if you are working with big BLOB columns), you can increase the query limit by setting the server’s max_allowed_packet variable, which has a default value of 64MB. You may also need to increase the maximum packet size on the client end. More information on setting the packet size is given in Section B.3.2.8, “Packet Too Large”.</p>
</li>
<li><p>An INSERT or REPLACE statement that inserts <strong>a great many rows</strong> can also cause these sorts of errors. Either one of these statements sends a single request to the server irrespective of the number of rows to be inserted; thus, you can often avoid the error by reducing the number of rows sent per INSERT or REPLACE.</p>
</li>
<li><p>It is also possible to see this error if <strong>host name lookups fail</strong> (for example, if the DNS server on which your server or network relies goes down). This is because MySQL is dependent on the host system for name resolution, but has no way of knowing whether it is working—from MySQL’s point of view the problem is indistinguishable from any other network timeout.<br>You may also see the MySQL server has gone away error if MySQL is started with the skip_networking system variable enabled.</p>
</li>
<li><p>Another networking issue that can cause this error occurs if the MySQL port (default 3306) is blocked by your <strong>firewall</strong>, thus preventing any connections at all to the MySQL server.</p>
</li>
<li><p>You can also encounter this error with applications that <strong>fork child processes</strong>, all of which try to use the same connection to the MySQL server. This can be avoided by using a separate connection for each child process.(x)</p>
</li>
<li><p>You have encountered a <strong>bug</strong> where the server died while executing the query.</p>
</li>
</ol>
<p>虽然官方列出的原因有很多，涵盖的范围也比较广：包括客户端、服务端、driver、网络连接、甚至DBA的人为操作原因，根据我们的问题背景在过滤调其中一部分之后，可以看出主要还是围绕 <strong>超时断开链接</strong> 这一核心原因展开的分析，下面我们再针对这些详细情况逐一进行排查。</p>
<h3 id="pdo-长链接"><a href="#pdo-长链接" class="headerlink" title="pdo 长链接"></a><strong>pdo 长链接</strong></h3><p><em>长连接依托于常驻进程，命令行模式下，脚本执行完毕后连接必然会被释放，在php-fpm执行模式下，fastcgi执行完一次请求后，后面的请求可以继续复用前一次请求创建的连接，从而省去了建立连接的开销，提升了性能。</em></p>
<h2 id="三、排查过程"><a href="#三、排查过程" class="headerlink" title="三、排查过程"></a>三、排查过程</h2><h3 id="1-wait-timeout"><a href="#1-wait-timeout" class="headerlink" title="1.wait_timeout"></a>1.wait_timeout</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">The number of seconds the server waits for activity on a noninteractive connection before closing it.</span><br></pre></td></tr></table></figure>

<p>wait_timeout是一个全局变量，指的是在客户端与服务器建立链接后超过该变量指定的时间（单位秒）未发送任何指令，链接将会自动断开。通过下面命令可以查看当前mysql服务中的各种超时时间配置。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">MariaDB []<span class="operator">&gt;</span> <span class="keyword">show</span> <span class="keyword">global</span> variables <span class="keyword">like</span> <span class="string">&#x27;%timeout&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------------------+----------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name               <span class="operator">|</span> <span class="keyword">Value</span>    <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------------------+----------+</span></span><br><span class="line"><span class="operator">|</span> connect_timeout             <span class="operator">|</span> <span class="number">10</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> delayed_insert_timeout      <span class="operator">|</span> <span class="number">300</span>      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> innodb_flush_log_at_timeout <span class="operator">|</span> <span class="number">1</span>        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> innodb_lock_wait_timeout    <span class="operator">|</span> <span class="number">50</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> innodb_rollback_on_timeout  <span class="operator">|</span> OFF      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> interactive_timeout         <span class="operator">|</span> <span class="number">28800</span>    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> lock_wait_timeout           <span class="operator">|</span> <span class="number">31536000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> net_read_timeout            <span class="operator">|</span> <span class="number">30</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> net_write_timeout           <span class="operator">|</span> <span class="number">60</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> slave_net_timeout           <span class="operator">|</span> <span class="number">3600</span>     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> thread_pool_idle_timeout    <span class="operator">|</span> <span class="number">60</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> wait_timeout                <span class="operator">|</span> <span class="number">28800</span>    <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------------------+----------+</span></span><br><span class="line"><span class="number">12</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
<p>wait_timeout 和 interactive_timeout配置的都是八小时的超时时间，此项不是导致问题产生的原因，继续往下看吧。</p>
<h3 id="2-检查mysql-server端状态"><a href="#2-检查mysql-server端状态" class="headerlink" title="2.检查mysql server端状态"></a>2.检查mysql server端状态</h3><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Aborted_clients 由于客户没有正确关闭连接已经死掉，已经放弃的连接数量。 </span><br><span class="line">Aborted_connects 尝试已经失败的MySQL服务器的连接的次数。 </span><br><span class="line">Connections 试图连接MySQL服务器的次数。 </span><br><span class="line">Threads_connected 当前打开的连接的数量。 </span><br><span class="line">Threads_running 不在睡眠的线程数量。 </span><br><span class="line">Uptime 服务器工作了多少秒。</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [(<span class="keyword">none</span>)]<span class="operator">&gt;</span> <span class="keyword">show</span> status <span class="keyword">like</span> <span class="string">&#x27;Threads%&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------+-------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name     <span class="operator">|</span> <span class="keyword">Value</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------+-------+</span></span><br><span class="line"><span class="operator">|</span> Threads_cached    <span class="operator">|</span> <span class="number">16</span>    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Threads_connected <span class="operator">|</span> <span class="number">380</span>   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Threads_created   <span class="operator">|</span> <span class="number">25347</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Threads_running   <span class="operator">|</span> <span class="number">3</span>     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------+-------+</span></span><br><span class="line"><span class="number">4</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MariaDB [(<span class="keyword">none</span>)]<span class="operator">&gt;</span> <span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;thread_cache_size&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------+-------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name     <span class="operator">|</span> <span class="keyword">Value</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------+-------+</span></span><br><span class="line"><span class="operator">|</span> thread_cache_size <span class="operator">|</span> <span class="number">30</span>    <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------+-------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<h3 id="3-检查mysql服务器网络连接状态"><a href="#3-检查mysql服务器网络连接状态" class="headerlink" title="3.检查mysql服务器网络连接状态"></a>3.检查mysql服务器网络连接状态</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">root@ALI-68-95:&#x2F;home&#x2F;developer# netstat -ap|grep 192.168.68.90</span><br><span class="line">tcp        0      0 ALI-68-95:mysql         192.168.68.90:31168     ESTABLISHED 2520&#x2F;mysqld</span><br><span class="line">tcp        0      0 ALI-68-95:mysql         192.168.68.90:36708     ESTABLISHED 2520&#x2F;mysqld</span><br><span class="line">tcp        0      0 ALI-68-95:mysql         192.168.68.90:34118     ESTABLISHED 2520&#x2F;mysqld</span><br><span class="line">tcp        0      0 ALI-68-95:mysql         192.168.68.90:57158     ESTABLISHED 2520&#x2F;mysqld</span><br><span class="line">tcp        0      0 ALI-68-95:mysql         192.168.68.90:37692     ESTABLISHED 2520&#x2F;mysqld</span><br><span class="line">tcp        0      0 ALI-68-95:mysql         192.168.68.90:39896     ESTABLISHED 2520&#x2F;mysqld</span><br><span class="line">tcp        0      0 ALI-68-95:mysql         192.168.68.90:34288     ESTABLISHED 2520&#x2F;mysqld</span><br><span class="line">tcp        0      0 ALI-68-95:mysql         192.168.68.90:36006     ESTABLISHED 2520&#x2F;mysqld</span><br><span class="line">tcp        0      0 ALI-68-95:mysql         192.168.68.90:37960     ESTABLISHED 2520&#x2F;mysqld</span><br><span class="line">tcp        0      0 ALI-68-95:mysql         192.168.68.90:37430     ESTABLISHED 2520&#x2F;mysqld</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<h3 id="4-使用脚本建立mysql连接，模拟客户端请求"><a href="#4-使用脚本建立mysql连接，模拟客户端请求" class="headerlink" title="4.使用脚本建立mysql连接，模拟客户端请求"></a>4.使用脚本建立mysql连接，模拟客户端请求</h3><p>其实最好是使用fpm，把max_children调为1来模拟客户端请求，但是我们开发机同测试环境，nginx和fpm配置不是很方便修改，自己的虚拟机是10网段的也连不上线上的db，所以我们简单用php脚本模拟一下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$_REQUEST</span>[<span class="string">&#x27;serverappenv&#x27;</span>] = <span class="string">&quot;online&quot;</span>;</span><br><span class="line">ini_set(<span class="string">&quot;error_reporting&quot;</span>, E_ALL);</span><br><span class="line">ini_set(<span class="string">&quot;display_errors&quot;</span>, <span class="literal">TRUE</span>);</span><br><span class="line"><span class="keyword">require</span> <span class="keyword">__DIR__</span> . <span class="string">&#x27;/../bootstrap/app.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$connectId</span> = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">while</span> (<span class="variable">$connectId</span>++ &lt; <span class="number">2</span>) &#123;</span><br><span class="line">    <span class="variable">$conn</span> =  \app\connector\mysql\PeanutWrite::getInstance();</span><br><span class="line">    var_dump(<span class="variable">$conn</span>-&gt;pdo-&gt;getAttribute(PDO::ATTR_CONNECTION_STATUS));</span><br><span class="line">    <span class="variable">$conn</span>::<span class="variable">$instance</span> = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    sleep(<span class="number">10</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>脚本运行同时连接mysql查看来自88的连接状态</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [(<span class="keyword">none</span>)]<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> information_schema.processlist <span class="keyword">where</span> host <span class="keyword">like</span> <span class="string">&#x27;192.168.68.88%&#x27;</span>\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           ID: <span class="number">788079</span></span><br><span class="line">         <span class="keyword">USER</span>: xie</span><br><span class="line">         HOST: <span class="number">192.168</span><span class="number">.68</span><span class="number">.88</span>:<span class="number">61470</span></span><br><span class="line">           DB: peanut</span><br><span class="line">      COMMAND: Sleep</span><br><span class="line">         <span class="type">TIME</span>: <span class="number">1</span></span><br><span class="line">        STATE:</span><br><span class="line">         INFO: <span class="keyword">NULL</span></span><br><span class="line">      TIME_MS: <span class="number">1385.269</span></span><br><span class="line">        STAGE: <span class="number">0</span></span><br><span class="line">    MAX_STAGE: <span class="number">0</span></span><br><span class="line">     PROGRESS: <span class="number">0.000</span></span><br><span class="line">  MEMORY_USED: <span class="number">61168</span></span><br><span class="line">EXAMINED_ROWS: <span class="number">0</span></span><br><span class="line">     QUERY_ID: <span class="number">0</span></span><br><span class="line">  INFO_BINARY: <span class="keyword">NULL</span></span><br><span class="line">          TID: <span class="number">847</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">2.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           ID: <span class="number">788078</span></span><br><span class="line">         <span class="keyword">USER</span>: xie</span><br><span class="line">         HOST: <span class="number">192.168</span><span class="number">.68</span><span class="number">.88</span>:<span class="number">61468</span></span><br><span class="line">           DB: <span class="keyword">NULL</span></span><br><span class="line">      COMMAND: Query</span><br><span class="line">         <span class="type">TIME</span>: <span class="number">0</span></span><br><span class="line">        STATE: Filling schema <span class="keyword">table</span></span><br><span class="line">         INFO: <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> information_schema.processlist <span class="keyword">where</span> host <span class="keyword">like</span> <span class="string">&#x27;192.168.68.88%&#x27;</span></span><br><span class="line">      TIME_MS: <span class="number">0.396</span></span><br><span class="line">        STAGE: <span class="number">0</span></span><br><span class="line">    MAX_STAGE: <span class="number">0</span></span><br><span class="line">     PROGRESS: <span class="number">0.000</span></span><br><span class="line">  MEMORY_USED: <span class="number">76616</span></span><br><span class="line">EXAMINED_ROWS: <span class="number">0</span></span><br><span class="line">     QUERY_ID: <span class="number">100217568</span></span><br><span class="line">  INFO_BINARY: <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> information_schema.processlist <span class="keyword">where</span> host <span class="keyword">like</span> <span class="string">&#x27;192.168.68.88%&#x27;</span></span><br><span class="line">          TID: <span class="number">7860</span></span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<p>现象：当sleep(10)时每次循环建立的连接id不变，说明 persistent 生效。</p>
<h2 id="5-把目光转向从库"><a href="#5-把目光转向从库" class="headerlink" title="5.把目光转向从库"></a>5.把目光转向从库</h2><!-- ![image.png](https://i.loli.net/2021/04/28/zP5CTuFgYMeyXUl.png) -->
<p><img src="https://github.com/chenruosong/blog/blob/master/source/image/PdoMysqlPersistent/291F3661-B03E-40AA-AEC6-0B11CB1F6F98.png" alt="image.png"></p>
<!-- ![image.png](https://i.loli.net/2021/04/28/v8KluJa7j2UyYmL.png) -->

<p><img src="https://github.com/chenruosong/blog/blob/master/source/image/PdoMysqlPersistent/893089C7-4599-4D6A-9F88-1FACF3251913.png" alt="image.png"></p>
<p>发现连接的端口号变化频繁，且10上出现多个tcp连接状态为<strong>FIN_WAIT2</strong>,(主动关闭端接到ACK后)；90上则为<strong>CLOSE_WAIT</strong>（被动关闭端TCP接到FIN后，就发出ACK以回应FIN请求(它的接收也作为文件结束符传递给上层应用程序)</p>
<!-- ![image.png](https://i.loli.net/2021/04/28/3aiMD2QxfyWA1Ze.png) -->
<p><img src="https://github.com/chenruosong/blog/blob/master/source/image/PdoMysqlPersistent/3aiMD2QxfyWA1Ze.png" alt="image.png"><br>也就是说90上保存的到10:3333端口haproxy的长连接是被10主动关闭的，接下来我们检查ha的连接断开原因即可。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">root@ALI-68-10:&#x2F;home&#x2F;developer# cat &#x2F;etc&#x2F;haproxy&#x2F;haproxy.cfg</span><br><span class="line">global</span><br><span class="line">	log &#x2F;dev&#x2F;log	local0</span><br><span class="line">	log &#x2F;dev&#x2F;log	local1 notice</span><br><span class="line">	chroot &#x2F;var&#x2F;lib&#x2F;haproxy</span><br><span class="line">	stats socket &#x2F;run&#x2F;haproxy&#x2F;admin.sock mode 660 level admin</span><br><span class="line">	#stats timeout 30s</span><br><span class="line">	stats timeout 3600s</span><br><span class="line">	user haproxy</span><br><span class="line">	group haproxy</span><br><span class="line">	daemon</span><br><span class="line"></span><br><span class="line">	# Default SSL material locations</span><br><span class="line">	ca-base &#x2F;etc&#x2F;ssl&#x2F;certs</span><br><span class="line">	crt-base &#x2F;etc&#x2F;ssl&#x2F;private</span><br><span class="line"></span><br><span class="line">	# Default ciphers to use on SSL-enabled listening sockets.</span><br><span class="line">	# For more information, see ciphers(1SSL). This list is from:</span><br><span class="line">	#  https:&#x2F;&#x2F;hynek.me&#x2F;articles&#x2F;hardening-your-web-servers-ssl-ciphers&#x2F;</span><br><span class="line">	# An alternative list with additional directives can be obtained from</span><br><span class="line">	#  https:&#x2F;&#x2F;mozilla.github.io&#x2F;server-side-tls&#x2F;ssl-config-generator&#x2F;?server&#x3D;haproxy</span><br><span class="line">	ssl-default-bind-ciphers ECDH+AESGCM:DH+AESGCM:ECDH+AES256:DH+AES256:ECDH+AES128:DH+AES:RSA+AESGCM:RSA+AES:!aNULL:!MD5:!DSS</span><br><span class="line">	ssl-default-bind-options no-sslv3</span><br><span class="line"></span><br><span class="line">defaults</span><br><span class="line">	log	global</span><br><span class="line">	mode	http</span><br><span class="line">	option	httplog</span><br><span class="line">	option	dontlognull</span><br><span class="line">        timeout connect 5000</span><br><span class="line"></span><br><span class="line">        #timeout client  50000 # 和客户端保持空闲连接的超时时长</span><br><span class="line">        timeout client  3600s</span><br><span class="line"></span><br><span class="line">        #timeout server  50000 # 和服务端保持空闲连接的超时时长</span><br><span class="line">        timeout server  3600s</span><br><span class="line">	errorfile 400 &#x2F;etc&#x2F;haproxy&#x2F;errors&#x2F;400.http</span><br><span class="line">	errorfile 403 &#x2F;etc&#x2F;haproxy&#x2F;errors&#x2F;403.http</span><br><span class="line">	errorfile 408 &#x2F;etc&#x2F;haproxy&#x2F;errors&#x2F;408.http</span><br><span class="line">	errorfile 500 &#x2F;etc&#x2F;haproxy&#x2F;errors&#x2F;500.http</span><br><span class="line">	errorfile 502 &#x2F;etc&#x2F;haproxy&#x2F;errors&#x2F;502.http</span><br><span class="line">	errorfile 503 &#x2F;etc&#x2F;haproxy&#x2F;errors&#x2F;503.http</span><br><span class="line">	errorfile 504 &#x2F;etc&#x2F;haproxy&#x2F;errors&#x2F;504.http</span><br><span class="line">listen mysql</span><br><span class="line">        bind  0.0.0.0:3333</span><br><span class="line">        mode tcp</span><br><span class="line">        option  tcplog</span><br><span class="line">        #balance roundrobin</span><br><span class="line">        acl allow_1  src 192.168.0.0&#x2F;16</span><br><span class="line">        acl allow_2  src 10.10.248.0&#x2F;24</span><br><span class="line">        tcp-request content  accept if allow_1</span><br><span class="line">        tcp-request content  accept if allow_2</span><br><span class="line">        tcp-request content  reject</span><br><span class="line">        balance leastconn</span><br><span class="line">        server mysql_96 192.168.68.96:3306 weight 1 check port 3306 inter 10s rise 2 fall 2 maxconn 600</span><br><span class="line">        server mysql_97 192.168.68.97:3306 weight 1 check port 3306 inter 10s rise 2 fall 2 maxconn 600</span><br><span class="line">        #option tcpka</span><br></pre></td></tr></table></figure>
<p>其中将timeout client/server 为空闲连接的超时时长，单位为毫秒 50000也就是50s，怀疑是一个php-fpm worker进程上的到mysql从库的ha连接空闲50后断开，但是PDO长连接不知道，在首次new PDO对象时依然使用旧连接，导致报出warning：mysql gone away，改为3600s后：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@ALI-68-10:&#x2F;home&#x2F;developer#  netstat -nat |grep &#39;192.168.68.90&#39;|awk &#39;&#123;print $6&#125;&#39;|sort|uniq -c</span><br><span class="line">    159 ESTABLISHED</span><br></pre></td></tr></table></figure>
<p>问题解决。</p>
<h2 id="四、后续"><a href="#四、后续" class="headerlink" title="四、后续"></a>四、后续</h2><p>目前我们线上服务器的一些设置</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [(<span class="keyword">none</span>)]<span class="operator">&gt;</span> <span class="keyword">show</span> variables <span class="keyword">like</span> &quot;max_connections%&quot;;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+-------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name   <span class="operator">|</span> <span class="keyword">Value</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+-------+</span></span><br><span class="line"><span class="operator">|</span> max_connections <span class="operator">|</span> <span class="number">1000</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+-------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">developer@ALI-68-90:~$ cat &#x2F;etc&#x2F;php&#x2F;7.0&#x2F;fpm&#x2F;pool.d&#x2F;www.conf|grep child</span><br><span class="line">;修改了php7的最大child</span><br><span class="line">pm.max_children &#x3D; 150</span><br></pre></td></tr></table></figure>
<p>在只有两台fpm的情况下最大空闲长连接数理论上可以达到300，现阶段qps不高但情况下一台get机常驻50个php-fpm子进程是没问题的，但想象一下，如果我们扩展到10台php服务器，每台服务器都是100+的子进程，一旦达到mysql最大连接数，就会造成too many   connections的问题，且空闲连接数过多也会增加mysql服务器的压力。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://chenruosong.com/2021/04/19/Netty-%E6%A0%B8%E5%BF%83%E7%BB%84%E4%BB%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Chen">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="凉凉的超人">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/04/19/Netty-%E6%A0%B8%E5%BF%83%E7%BB%84%E4%BB%B6/" class="post-title-link" itemprop="url">Netty 核心组件</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-04-19 11:15:00" itemprop="dateCreated datePublished" datetime="2021-04-19T11:15:00+08:00">2021-04-19</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-04-28 17:14:36" itemprop="dateModified" datetime="2021-04-28T17:14:36+08:00">2021-04-28</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <hr>
<h2 id="NioEventLoopGroup"><a href="#NioEventLoopGroup" class="headerlink" title="NioEventLoopGroup"></a>NioEventLoopGroup</h2><p>主要管理 NioEventLoop 的生命周期，可以理解为一个线程池，内部维护了一组线程，每个线程 (NioEventLoop)负责处理多个 Channel 上的事件，而一个 Channel 只对应于一个线程。</p>
<ol>
<li>Netty 抽象出两组线程池 BossGroup 和 WorkerGroup , BossGroup 处理连接请求，workerGroup负责网络读写、完成真正的和客户端业务处理；</li>
<li>BossGroup 和 WorkerGroup 都是 NioEventLoopGroup</li>
<li>NioEventLoopGroup 相当于一个[事件循环线程组],这个组中含有多个[事件循环线程]，每一个事件循环线程是NioEventLoop</li>
<li>每个 NioEventLoop 都有一个selector，用于监听注册在其上的socketChannel的网络通讯。</li>
<li>每个Boss NioEventLoop线程内部执行循环的步骤：<ul>
<li>处理accept事件，与client建立连接，生成NioSocketChannel</li>
<li>将NioSocketChannel注册到某个Worker NioEventLoop 上的 selector</li>
<li>处理任务队列的任务，即runAllTasks。</li>
</ul>
</li>
<li>每个Worker NioEventLoop线程内部循环执行步骤：<ul>
<li>轮询注册到自己selector上的所有NioSocketChannel的read，write事件</li>
<li>处理 I/O 事件，在对应的channel处理业务</li>
<li>runAllTasks处理任务队列TaskQueue的任务，一些耗时的业务处理一般可以放在TaskQeueu中处理，这样不影响数据在pipeline中的流动处理</li>
</ul>
</li>
<li>每个worker NioEventLoop处理NioSocketChannel业务时，会使用pipeline，管道中维护了很多handler处理器用来处理channel中的数据</li>
<li>NioEventLoop 中维护了一个线程和任务队列，支持异步提交执行任务，线程启动时会调用 NioEventLoop 的 run 方 法，执行 I/O 任务和非 I/O 任务:<br>I/O任务，即 selectionKey 中 ready 的事件，如 accept、connect、read、write 等，由 processSelectedKeys 方法触发。<br>非IO任务，添加到 taskQueue 中的任务，如 register0、bind0 等任务，由 runAllTasks 方法触发。</li>
</ol>
<h2 id="Bootstrap、ServerBootstrap"><a href="#Bootstrap、ServerBootstrap" class="headerlink" title="Bootstrap、ServerBootstrap"></a>Bootstrap、ServerBootstrap</h2><p>启动类。一个Netty应用通常由一个Bootstrap开始主要作用是配置整个Netty程序,串联各个组件。</p>
<h2 id="Channel"><a href="#Channel" class="headerlink" title="Channel"></a>Channel</h2><p>Netty 网络通信的组建，能够用于执行网络IO操作，Channel为用户提供：</p>
<ol>
<li>当前网络连接的通道的状态（是否打开，是否连接）</li>
<li>网络连接的配置参数（buffer大小）</li>
<li>提供异步的网络IO操作（建立连接、读写、绑定端口),异步调用意味着任何IO操作都将立即返回，并且不保证在调用结束时所请求的IO操作都已完成。</li>
<li>调用立即返回一个ChannelFutrue实例，通过注册监听器到ChannelFutrue上，可以在IO操作成功/失败/取消时回调通知调用方。</li>
<li>支持关联IO操作与对应的处理程序。不同协议、不同阻塞类型的连接都有不同的channel类型与之对应。<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">NioSocketChannel，异步的客户端TCP Socket连接</span><br><span class="line">NioServerSocketChannel, 异步的服务器端 TCP Socket 连接。</span><br><span class="line">NioDatagramChannel, 异步的 UDP 连接。</span><br><span class="line">NioSctpChannel, 异步的客户端 Sctp 连接。</span><br><span class="line">NioSctpServerChannel, 异步的服务端 Sctp 连接。</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="ChannelHandler"><a href="#ChannelHandler" class="headerlink" title="ChannelHandler"></a>ChannelHandler</h2><p>ChannelHandler 是一个接口，处理 I/O 事件或拦截 I/O 操作，并将其转发到其 ChannelPipeline(业务处理链)中的 下一个处理程序。<br>ChannelHandler 本身并没有提供很多方法，因为这个接口有许多的方法需要实现，方便使用期间，可以继承它的子类:</p>
<ul>
<li>ChannelInboundHandler 用于处理入栈 I/O 事件。</li>
<li>ChannelOutboundHandler 用于处理出栈 I/O 操作。</li>
</ul>
<p>或者使用以下适配器：</p>
<ul>
<li>ChannelInboundHandlerAdapter 用于处理入栈 I/O 事件。</li>
<li>ChannelOutboundHandlerAdapter 用于处理出栈 I/O 操作。</li>
</ul>
<h2 id="ChannelHandlerContext"><a href="#ChannelHandlerContext" class="headerlink" title="ChannelHandlerContext"></a>ChannelHandlerContext</h2><p>保存 Channel 相关的所有上下文信息，上下文对象，含有通道channel、管道pipeline,同时关联一个 ChannelHandler 对象。</p>
<h2 id="ChannelPipeline"><a href="#ChannelPipeline" class="headerlink" title="ChannelPipeline"></a>ChannelPipeline</h2><p>保存 ChannelHandler 的 List，用于处理或拦截 Channel 的入站事件和出站操作。<br>ChannelPipeline 实现了一种高级形式的拦截过滤器模式，使用户可以完全控制事件的处理方式，以及 Channel 中各 个的 ChannelHandler 如何相互交互。<br>在 Netty 中每个 Channel 都有且仅有一个 ChannelPipeline 与之对应，它们的组成关系如下:</p>
<p><img src="https://i.loli.net/2021/04/19/ZCh4jPpUA67X8FS.png" alt="channelPipeline"></p>
<!-- ![channelPipeline](/source/image/Netty/1BE31150-13AD-4701-9A6E-5585EE59EB30.png) -->
<!-- ![channelPipeline](public/image/Netty/1BE31150-13AD-4701-9A6E-5585EE59EB30.png) -->

<p>一个 Channel 包含了一个 ChannelPipeline，而 ChannelPipeline 中又维护了一个由 ChannelHandlerContext 组 成的双向链表，<br>并且每个 ChannelHandlerContext 中又关联着一个 ChannelHandler。 read事件(入站事件)和write事件(出站事件)在一个双向链表中，<br>入站事件会从链表 head 往后传递到最后一个入站的 handler，<br>出站事件会从链表 tail 往前传递到最前一个出站的 handler，<br>两种类型的 handler 互不干扰。</p>
<p>SocketChannel.pipeline().addLast()方法操作链表指针，将channelHandler加入到链表的尾部。</p>
<h2 id="Future、ChannelFuture"><a href="#Future、ChannelFuture" class="headerlink" title="Future、ChannelFuture"></a>Future、ChannelFuture</h2><p>Netty中所有IO操作都是异步的，不能立刻得知消息是否被正确处理。Futrue可以注册一个监听，当操作执行成功或失败时监听会自动触发注册的监听事件</p>
<h2 id="Selector"><a href="#Selector" class="headerlink" title="Selector"></a>Selector</h2><p>Netty 基于 selector 对象实现IO多路复用，通过selector一个线程可以监听多个连接的channel的事件。<br>当向一个selector中注册channel后，selector内部的机制就可以自动不断地查询（select）这些注册的Channel是否有已就绪的IO事件。</p>
<h2 id="ByteBuf"><a href="#ByteBuf" class="headerlink" title="ByteBuf"></a>ByteBuf</h2><p>从结构上来说，ByteBuf 由一串字节数组构成。即相当于</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">byte[] bytes &#x3D; new byte[1024];</span><br></pre></td></tr></table></figure>

<p>ByteBuf 提供了两个索引，一个用于读取数据，一个用于写入数据。这两个索引通过在字节数组中移动，来定 位需要读或者写信息的位置。<br>当从 ByteBuf 读取时，它的 readerIndex 将会根据读取的字节数递增。<br>同样，当写 ByteBuf 时，它的 writerIndex 也会根据写入的字节数进行递增。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Chen</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">6</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Chen</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
